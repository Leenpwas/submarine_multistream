cmake_minimum_required(VERSION 3.10)
project(submarine_vision)

set(CMAKE_CXX_STANDARD 14)

# Detect architecture
if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64")
    set(ORBBEC_LIB_DIR "arm64")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "armv7")
    set(ORBBEC_LIB_DIR "arm32")
else()
    set(ORBBEC_LIB_DIR "linux_x64")
endif()

# OrbbecSDK path
if(EXISTS "${CMAKE_SOURCE_DIR}/OrbbecSDK_minimal")
    set(ORBBEC_SDK "${CMAKE_SOURCE_DIR}/OrbbecSDK_minimal")
elseif(EXISTS "${CMAKE_SOURCE_DIR}/../OrbbecSDK")
    set(ORBBEC_SDK "${CMAKE_SOURCE_DIR}/../OrbbecSDK")
elseif(EXISTS "$ENV{HOME}/OrbbecSDK")
    set(ORBBEC_SDK "$ENV{HOME}/OrbbecSDK")
else()
    message(FATAL_ERROR "Cannot find OrbbecSDK")
endif()

# Find OpenCV
find_package(OpenCV REQUIRED)

include_directories(
    ${ORBBEC_SDK}/include
    ${ORBBEC_SDK}/examples/cpp
    ${OpenCV_INCLUDE_DIRS}
)

link_directories(
    ${ORBBEC_SDK}/lib/${ORBBEC_LIB_DIR}
)

# ==================== VISION SYSTEM ====================

# Submarine Vision Sender (Submarine Pi - with camera)
add_executable(submarine_vision_sender submarine_vision_sender.cpp)
target_link_libraries(submarine_vision_sender OrbbecSDK ${OpenCV_LIBS} pthread)

# Submarine Vision Receiver (Surface Pi - display)
add_executable(submarine_vision_receiver submarine_vision_receiver.cpp)
target_link_libraries(submarine_vision_receiver ${OpenCV_LIBS} pthread)

# Internet Color Sender (streams color over internet)
add_executable(internet_color_sender internet_color_sender.cpp)
target_link_libraries(internet_color_sender OrbbecSDK ${OpenCV_LIBS} pthread)

# ML Object Detection Receiver (receives color, runs detection, displays GUI)
add_executable(ml_receiver ml_receiver.cpp)
target_link_libraries(ml_receiver ${OpenCV_LIBS} pthread)

# Web Sender (Pi - lightweight sender for web streaming)
add_executable(web_sender web_sender.cpp)
target_link_libraries(web_sender OrbbecSDK ${OpenCV_LIBS} pthread)

# Set RPATH
set_target_properties(submarine_vision_sender submarine_vision_receiver internet_color_sender web_sender PROPERTIES
    BUILD_RPATH "${ORBBEC_SDK}/lib/${ORBBEC_LIB_DIR}"
    INSTALL_RPATH "${ORBBEC_SDK}/lib/${ORBBEC_LIB_DIR}"
)
